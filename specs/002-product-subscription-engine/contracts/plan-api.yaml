openapi: 3.0.3
info:
  title: Billing Plan Management API
  description: API for managing billing plans (Free, Pro, Enterprise tiers) in the SaaS billing platform
  version: 1.0.0
  contact:
    name: Enterprise SaaS Billing Team

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://api.billing.example.com/api/v1
    description: Production server

tags:
  - name: Plans
    description: Billing plan management operations (Admin only)

paths:
  /plans:
    get:
      tags:
        - Plans
      summary: List all billing plans
      description: Retrieve a paginated list of all active billing plans. Cached for performance.
      operationId: getAllPlans
      parameters:
        - name: page
          in: query
          description: Page number (0-indexed)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          description: Page size
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: sort
          in: query
          description: Sort criteria (e.g., "name,asc" or "price,desc")
          required: false
          schema:
            type: string
            default: "name,asc"
      responses:
        '200':
          description: Successfully retrieved plans
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanListResponse'
              example:
                content:
                  - id: 1
                    name: "Free"
                    description: "Basic features for individuals"
                    price: 0.00
                    billingCycle: "MONTHLY"
                    featureLimits:
                      - limitType: "api_calls"
                        limitValue: 100
                      - limitType: "max_users"
                        limitValue: 1
                  - id: 2
                    name: "Pro"
                    description: "Advanced features for professionals"
                    price: 29.99
                    billingCycle: "MONTHLY"
                    featureLimits:
                      - limitType: "api_calls"
                        limitValue: 10000
                      - limitType: "max_users"
                        limitValue: 10
                totalElements: 2
                totalPages: 1
                pageNumber: 0
                pageSize: 20
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Plans
      summary: Create a new billing plan
      description: Create a new billing plan with pricing and feature limits. Admin only.
      operationId: createPlan
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePlanRequest'
            example:
              name: "Enterprise"
              description: "Full features for organizations"
              price: 299.99
              billingCycle: "YEARLY"
              featureLimits:
                - limitType: "api_calls"
                  limitValue: 1000000
                - limitType: "max_users"
                  limitValue: 100
      responses:
        '201':
          description: Plan created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: Plan with this name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                timestamp: "2026-01-25T14:30:00Z"
                status: 409
                error: "Conflict"
                message: "Plan with name 'Enterprise' already exists"
                path: "/api/v1/plans"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /plans/{id}:
    get:
      tags:
        - Plans
      summary: Get plan by ID
      description: Retrieve details of a specific billing plan by its ID. Cached for performance.
      operationId: getPlanById
      parameters:
        - name: id
          in: path
          description: Plan ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Successfully retrieved plan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Plan not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                timestamp: "2026-01-25T14:30:00Z"
                status: 404
                error: "Not Found"
                message: "Plan with ID 999 not found"
                path: "/api/v1/plans/999"
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Plans
      summary: Update an existing plan
      description: Update plan details (price, description, feature limits). Admin only. Evicts cache.
      operationId: updatePlan
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          description: Plan ID
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePlanRequest'
            example:
              description: "Premium features for professionals"
              price: 39.99
              featureLimits:
                - limitType: "api_calls"
                  limitValue: 15000
      responses:
        '200':
          description: Plan updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Plan not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Plans
      summary: Delete a billing plan
      description: Soft delete a billing plan. Fails if active subscriptions exist. Admin only.
      operationId: deletePlan
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          description: Plan ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: Plan deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Plan not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Cannot delete plan with active subscriptions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                timestamp: "2026-01-25T14:30:00Z"
                status: 409
                error: "Conflict"
                message: "Cannot delete plan 'Pro': 15 active subscriptions exist"
                path: "/api/v1/plans/2"
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from /api/v1/auth/login

  schemas:
    CreatePlanRequest:
      type: object
      required:
        - name
        - price
        - billingCycle
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Unique plan name
          example: "Pro"
        description:
          type: string
          maxLength: 500
          description: Plan description
          example: "Advanced features for professionals"
        price:
          type: number
          format: decimal
          minimum: 0
          description: Plan price in USD
          example: 29.99
        billingCycle:
          type: string
          enum: [MONTHLY, YEARLY]
          description: Billing frequency
          example: "MONTHLY"
        featureLimits:
          type: array
          items:
            $ref: '#/components/schemas/FeatureLimitRequest'
          description: List of feature limits

    UpdatePlanRequest:
      type: object
      properties:
        description:
          type: string
          maxLength: 500
          description: Updated plan description
        price:
          type: number
          format: decimal
          minimum: 0
          description: Updated plan price in USD
        featureLimits:
          type: array
          items:
            $ref: '#/components/schemas/FeatureLimitRequest'
          description: Updated feature limits

    FeatureLimitRequest:
      type: object
      required:
        - limitType
        - limitValue
      properties:
        limitType:
          type: string
          maxLength: 50
          description: Type of limit (e.g., api_calls, max_users)
          example: "api_calls"
        limitValue:
          type: integer
          minimum: 0
          description: Numeric limit value
          example: 10000

    PlanResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Plan ID
          example: 2
        name:
          type: string
          description: Plan name
          example: "Pro"
        description:
          type: string
          description: Plan description
          example: "Advanced features for professionals"
        price:
          type: number
          format: decimal
          description: Plan price in USD
          example: 29.99
        billingCycle:
          type: string
          enum: [MONTHLY, YEARLY]
          description: Billing frequency
          example: "MONTHLY"
        featureLimits:
          type: array
          items:
            $ref: '#/components/schemas/FeatureLimitResponse'
          description: List of feature limits
        createdDate:
          type: string
          format: date-time
          description: Creation timestamp
          example: "2026-01-25T10:00:00Z"
        lastModifiedDate:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2026-01-25T14:30:00Z"

    FeatureLimitResponse:
      type: object
      properties:
        limitType:
          type: string
          description: Type of limit
          example: "api_calls"
        limitValue:
          type: integer
          description: Numeric limit value
          example: 10000

    PlanListResponse:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/PlanResponse'
        totalElements:
          type: integer
          format: int64
          description: Total number of plans
        totalPages:
          type: integer
          description: Total number of pages
        pageNumber:
          type: integer
          description: Current page number (0-indexed)
        pageSize:
          type: integer
          description: Page size

    ErrorResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: Error timestamp
        status:
          type: integer
          description: HTTP status code
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Error message
        path:
          type: string
          description: Request path

  responses:
    BadRequest:
      description: Invalid request parameters or validation errors
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            timestamp: "2026-01-25T14:30:00Z"
            status: 400
            error: "Bad Request"
            message: "Validation failed: price must be non-negative"
            path: "/api/v1/plans"

    Unauthorized:
      description: Authentication required or token invalid/expired
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            timestamp: "2026-01-25T14:30:00Z"
            status: 401
            error: "Unauthorized"
            message: "JWT token is missing or invalid"
            path: "/api/v1/plans"

    Forbidden:
      description: Insufficient permissions (requires ROLE_ADMIN)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            timestamp: "2026-01-25T14:30:00Z"
            status: 403
            error: "Forbidden"
            message: "Access denied: ROLE_ADMIN required"
            path: "/api/v1/plans"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            timestamp: "2026-01-25T14:30:00Z"
            status: 500
            error: "Internal Server Error"
            message: "An unexpected error occurred"
            path: "/api/v1/plans"
